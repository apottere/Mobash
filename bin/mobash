#!/bin/bash
# Compiled with MoBash v1.1

################################################################################
# INFO
################################################################################
#
# Name:		mobash
# Author:	Andrew Potter apottere@gmail.com
# Release:	1.1
# Date:		
#
# A simplistic modular bash compiler
#

################################################################################
# CONFIGS
################################################################################

MOBASH_VERSION="1.1"

# These are default values that will get overriden by a .mobashrc file found in
# any directory above where the mobash script resides.
MOBASH_CONFIG_PATH=""   # config_path
MOBASH_SOURCE_PATH=""   # source_path
MOBASH_INCLUDE_PATH=""  # include_path
MOBASH_IMPORT_PATH=""   # import_path
MOBASH_BIN_DIR=""       # bin_dir

################################################################################
# GENERATED CODE
################################################################################
mo_main () 
{ 
    function mobash_config_read_file () 
    { 
        if [[ -f $1 && -r $1 ]]; then
            mobash_config_read_BIFS=$IFS;
            unset IFS;
            for mobash_config_read_i in $(cat $1);
            do
                mobash_config_read_BIFS_2=$IFS;
                IFS='=';
                mobash_config_read_j=($mobash_config_read_i);
                mobash_config_switch_key "${mobash_config_read_j[0]}" "${mobash_config_read_j[1]}";
                IFS=$mobash_config_read_BIFS_2;
            done;
            IFS=$mobash_config_read_BIFS;
        fi
    };
    function mobash_config_switch_key () 
    { 
        case "$1" in 
            'config_path')
                MOBASH_CONFIG_PATH="$2"
            ;;
            'source_path')
                MOBASH_SOURCE_PATH="$2"
            ;;
            'include_path')
                MOBASH_INCLUDE_PATH="$2"
            ;;
            'import_path')
                MOBASH_IMPORT_PATH="$2"
            ;;
            'bin_dir')
                MOBASH_BIN_DIR="$2"
            ;;
        esac
    };
    function mobash_config_init () 
    { 
        echo -e "${YEL}Collapsing configs...$RS";
        mobash_config_init_BIFS=$IFS;
        IFS='
';
        for mobash_config_init_i in $(resolve_expanded_path $@);
        do
            mobash_config_read_file "${mobash_config_init_i}/.mobashrc";
        done;
        IFS=$mobash_config_init_BIFS;
        print_ln "%-${FORMAT_WIDTH}s" "  MOBASH_CONFIG_PATH: " $CYN;
        echo -e "${GRN}$MOBASH_CONFIG_PATH";
        print_ln "%-${FORMAT_WIDTH}s" "  MOBASH_SOURCE_PATH: " $CYN;
        echo -e "${GRN}$MOBASH_SOURCE_PATH";
        print_ln "%-${FORMAT_WIDTH}s" "  MOBASH_INCLUDE_PATH: " $CYN;
        echo -e "${GRN}$MOBASH_INCLUDE_PATH";
        print_ln "%-${FORMAT_WIDTH}s" "  MOBASH_IMPORT_PATH: " $CYN;
        echo -e "${GRN}$MOBASH_IMPORT_PATH";
        print_ln "%-${FORMAT_WIDTH}s" "  MOBASH_BIN_DIR: " $CYN;
        echo -e "${GRN}$MOBASH_BIN_DIR";
        echo
    };
    function mobash_finalize () 
    { 
        echo;
        print_ln "%-${FORMAT_WIDTH}s" "Finalizing script " $YEL;
        echo 'mo_main "$@"' >> $MOBASH_BIN_NEW;
        if [[ -n $PRESERVE_TEMP_FILES ]]; then
            cp $MOBASH_BIN_NEW $MOBASH_BIN;
        else
            mv $MOBASH_BIN_NEW $MOBASH_BIN;
        fi;
        chmod 755 $MOBASH_BIN;
        echo -e "$RS${GRN}Complete$RS";
        mobash_cleanup
    };
    function mobash_cleanup () 
    { 
        print_ln "%-${FORMAT_WIDTH}s" "Cleaning up files " $YEL;
        echo -e "$RS${GRN}Complete$RS";
        if [[ -z $PRESERVE_TEMP_FILES ]]; then
            rm $MOBASH_BIN_NEW >&/dev/null;
            rm $MOBASH_SOURCE_FILE_CUSTOM >&/dev/null;
        fi;
        exit
    };
    function mobash_resolve_function_for_file () 
    { 
        file=$1;
        func=$2;
        print_ln "%-${FORMAT_WIDTH}s" "    $func(): " $MGT;
        echo -n -e "$RED";
        bash -c 'source '$file'; if [[ $(declare -f '$func') == "" ]]; then exit 1; else declare -f '$func' | grep -v \"^$\" >> '$MOBASH_BIN_NEW'; fi';
        if [[ $? == 1 ]]; then
            echo -e "No valid function declaration found.$RS";
            echo;
            mobash_cleanup;
        else
            echo -e "$RS${GRN}Complete$RS";
        fi
    };
    function mobash_resolve_imports () 
    { 
        echo -e "${YEL}Building dependency list...$RS";
        mobash_source_file_name="$1.shs";
        declare -i MOBASH_IMPORTS_N;
        declare -a MOBASH_IMPORTS;
        unset MOBASH_IMPORTS_I;
        for mobash_include_i in "${!MOBASH_INCLUDE_FILES[@]}";
        do
            print_ln "%-${FORMAT_WIDTH}s" "  ${MOBASH_INCLUDE_FILES[$mobash_include_i]}: " $CYN;
            echo -e "${LGRN}${MOBASH_INCLUDE_ABSOLUTE_FILES[$mobash_include_i]}$RS";
            for mobash_import in `grep "^#@import" "${MOBASH_INCLUDE_ABSOLUTE_FILES[$mobash_include_i]}" | awk '{ print $2 }' | sort | uniq`;
            do
                mobash_insert_import $mobash_import "${MOBASH_INCLUDE_FILES[$mobash_include_i]}";
            done;
        done;
        declare -a mobash_imports_searched;
        unset MOBASH_IMPORT_FILES;
        mobash_imports_needed="true";
        while [[ -n $mobash_imports_needed ]]; do
            mobash_imports_needed="";
            for MOBASH_IMPORTS_N in "${!MOBASH_IMPORTS_I[@]}";
            do
                mobash_import="${MOBASH_IMPORTS_I[$MOBASH_IMPORTS_N]}";
                if [[ ! -n "${mobash_imports_searched[$MOBASH_IMPORTS_N]}" ]]; then
                    mobash_imports_searched[$MOBASH_IMPORTS_N]="true";
                    print_ln "%-${FORMAT_WIDTH}s" "  $mobash_import: " $CYN;
                    mobash_module=`echo -n "$mobash_import" | sed 's/\..*//'`;
                    if [[ ! -n `mobash_get_file_map_index $mobash_module` ]]; then
                        mobash_module_file=`resolve_file_in_path "$mobash_module.shm" "$MOBASH_IMPORT_PATH" ":"`;
                        if [[ ! -n $mobash_module_file ]]; then
                            echo -e "${RED}No file found in path for: $mobash_module$RS";
                            mobash_cleanup;
                        fi;
                        MOBASH_IMPORT_FILES_I[${#MOBASH_IMPORT_FILES[@]}]="$mobash_module";
                        MOBASH_IMPORT_FILES[${#MOBASH_IMPORT_FILES[@]}]="$mobash_module_file";
                    fi;
                    echo -e "${LGRN}${MOBASH_IMPORT_FILES[`mobash_get_file_map_index $mobash_module`]}$RS";
                    mobash_function_imports=`grep "^#@function $mobash_import:" "${MOBASH_IMPORT_FILES[$mobash_module]}" | awk -F': ' '{print $2}'`;
                    if [[ -n $mobash_function_imports ]]; then
                        BIFS="$IFS";
                        IFS=' ';
                        for mobash_function_import in $mobash_function_imports;
                        do
                            if mobash_insert_import "$mobash_function_import" "${MOBASH_IMPORTS[$MOBASH_IMPORTS_N]}->$mobash_module"; then
                                mobash_imports_needed="true";
                            fi;
                        done;
                        IFS="$BIFS";
                    fi;
                fi;
            done;
        done
    };
    function mobash_insert_import () 
    { 
        if [[ -n "$1" ]]; then
            print_ln "%-$(( $FORMAT_WIDTH + 2 ))s" "    $1: " $MGT;
            mobash_insert_import_n=`mobash_get_import_index $1`;
            if [[ -n $mobash_insert_import_n ]]; then
                echo -e "${LYEL}${MOBASH_IMPORTS[$mobash_insert_import_n]}$RS";
                return 1;
            else
                echo -e "${GRN}New dependency$RS";
                MOBASH_IMPORTS[${#MOBASH_IMPORTS_I[@]}]="$2";
                MOBASH_IMPORTS_I[${#MOBASH_IMPORTS_I[@]}]="$1";
                return 0;
            fi;
        fi
    };
    function mobash_get_file_map_index () 
    { 
        for mobash_file_map_index in "${!MOBASH_IMPORT_FILES_I[@]}";
        do
            if [[ "${MOBASH_IMPORT_FILES_I[$mobash_file_map_index]}" == "$1" ]]; then
                echo $mobash_file_map_index;
                return;
            fi;
        done
    };
    function mobash_transfer_import_contents () 
    { 
        echo -e "\n${YEL}Writing imports...$RS";
        mobash_transfer_current="";
        BIFS="$IFS";
        IFS='
';
        for mobash_import_s in `sort <<< "${MOBASH_IMPORTS_I[*]}"`;
        do
            IFS="$BIFS";
            declare -a mobash_transfer_parts=(${mobash_import_s/./ });
            if [[ ${mobash_transfer_parts[0]} != $mobash_transfer_current ]]; then
                if ! mobash_transfer_queued_contents; then
                    mobash_cleanup;
                fi;
                mobash_transfer_current="${mobash_transfer_parts[0]}";
                unset mobash_transfer_names;
                declare -a mobash_transfer_names;
            fi;
            mobash_transfer_names[${#mobash_transfer_names[@]}]="${mobash_transfer_parts[1]}";
            IFS='
';
        done;
        IFS="$BIFS";
        if ! mobash_transfer_queued_contents; then
            mobash_cleanup;
        fi
    };
    function mobash_transfer_queued_contents () 
    { 
        if [[ -n $mobash_transfer_current ]]; then
            print_ln "%-${FORMAT_WIDTH}s" "  $mobash_transfer_current: " $CYN;
            echo -n -e "$RED";
            ( if source ${MOBASH_IMPORT_FILES[`mobash_get_file_map_index $mobash_transfer_current`]}; then
                echo -e "$LGRN${MOBASH_IMPORT_FILES[`mobash_get_file_map_index $mobash_transfer_current`]}";
                for mobash_transfer_name in ${mobash_transfer_names[@]};
                do
                    print_ln "%-$(( $FORMAT_WIDTH + 2 ))s" "    $mobash_transfer_name: " $MGT;
                    declare -f "${mobash_transfer_current}_$mobash_transfer_name" >> $MOBASH_BIN_NEW;
                    echo -e "${GRN}Complete$RS";
                done;
            else
                return 1;
            fi );
        fi
    };
    function mobash_get_import_index () 
    { 
        for mobash_get_import_n in "${!MOBASH_IMPORTS_I[@]}";
        do
            if [[ "$1" == "${MOBASH_IMPORTS_I[$mobash_get_import_n]}" ]]; then
                echo $mobash_get_import_n;
                break;
            fi;
        done
    };
    function mobash_get_filenames () 
    { 
        print_ln "%-${FORMAT_WIDTH}s" "Resolving source " $YEL;
        MOBASH_SOURCE_FILE=`resolve_file_in_path "$1.shs" "$MOBASH_SOURCE_PATH" ":"`;
        if [[ "$MOBASH_SOURCE_FILE" == "" ]]; then
            echo -e "${RED}No source found in path for: $1.shs$RS";
            exit;
        fi;
        MOBASH_SOURCE_FILE_CUSTOM="$MOBASH_SOURCE_FILE.custom";
        echo -e "${LGRN}$MOBASH_SOURCE_FILE$RS";
        echo -e "${YEL}Finding includes...$RS";
        unset MOBASH_INCLUDE_FILES;
        unset MOBASH_INCLUDE_ABSOLUTE_FILES;
        MOBASH_INCLUDE_FILES[0]="$1.shs";
        MOBASH_INCLUDE_ABSOLUTE_FILES[0]="$MOBASH_SOURCE_FILE";
        for mobash_include_file in `grep "^#@include" "$MOBASH_SOURCE_FILE" | awk '{ print $2 }'`;
        do
            print_ln "%-${FORMAT_WIDTH}s" "  $mobash_include_file: " $CYN;
            mobash_include_absolute_file=`resolve_file_in_path "$mobash_include_file" "$MOBASH_INCLUDE_PATH" ":"`;
            if [[ -n "$mobash_include_absolute_file" ]]; then
                MOBASH_INCLUDE_ABSOLUTE_FILES[${#MOBASH_INCLUDE_FILES[@]}]="$mobash_include_absolute_file";
                MOBASH_INCLUDE_FILES[${#MOBASH_INCLUDE_FILES[@]}]="$mobash_include_file";
                echo -e "${LGRN}$mobash_include_absolute_file$RS";
            else
                echo -e "${RED}No source file in path for: $mobash_include_file$RS";
                mobash_cleanup;
            fi;
        done;
        MOBASH_CONFIG_FILE=`cat $MOBASH_SOURCE_FILE | grep "^#@config" | head -1 | awk '{ print $2 }'`;
        if [[ -n $MOBASH_CONFIG_FILE ]]; then
            echo;
            print_ln "%-${FORMAT_WIDTH}s" "Resolving config " $YEL;
            mobash_temp_config_file=`resolve_file_in_path "$MOBASH_CONFIG_FILE" "$MOBASH_CONFIG_PATH" ":"`;
            if [[ -n $mobash_temp_config_file ]]; then
                MOBASH_CONFIG_FILE="$mobash_temp_config_file";
                echo -e "${LGRN}$mobash_temp_config_file$RS";
            else
                echo -e "${RED}No config found in path for: $mobash_temp_config_file$RS";
                exit;
            fi;
        fi;
        print_ln "%-${FORMAT_WIDTH}s" "Resolving output " $YEL;
        MOBASH_BIN="`resolve_dir $MOBASH_BIN_DIR`/$1$MOBASH_BIN_EXTENSION";
        MOBASH_BIN_NEW="$MOBASH_BIN.new";
        echo -e "${LGRN}$MOBASH_BIN$RS"
    };
    function mobash_get_custom_contents () 
    { 
        echo -e "\n${YEL}Collecting custom...$RS";
        echo "mo_main() {" > $MOBASH_SOURCE_FILE_CUSTOM;
        for ((mobash_include_i=${#MOBASH_INCLUDE_ABSOLUTE_FILES[@]}-1 ; mobash_include_i>=0 ; mobash_include_i-- ))
        do
            mobash_include_f=${MOBASH_INCLUDE_ABSOLUTE_FILES[mobash_include_i]};
            print_ln "%-${FORMAT_WIDTH}s" "  $mobash_include_f: " $CYN;
            cat $mobash_include_f >> $MOBASH_SOURCE_FILE_CUSTOM;
            echo >> $MOBASH_SOURCE_FILE_CUSTOM;
            echo -e "${GRN}Complete$RS";
        done;
        echo "}" >> $MOBASH_SOURCE_FILE_CUSTOM;
        print_ln "%-${FORMAT_WIDTH}s" "Writing custom " $YEL;
        echo -n -e "$RED";
        if mobash_apply_custom_contents; then
            echo -e "$RS${GRN}Complete$RS";
        else
            echo -e -n "$RS";
            echo;
            mobash_cleanup;
        fi
    };
    function mobash_apply_custom_contents () 
    { 
        ( if source $MOBASH_SOURCE_FILE_CUSTOM; then
            declare -f mo_main >> $MOBASH_BIN_NEW;
        else
            return 1;
        fi )
    };
    function mobash_init_bin () 
    { 
        echo "#!/bin/bash" > $MOBASH_BIN_NEW;
        echo -e "# Compiled with MoBash v$MOBASH_VERSION\n" >> $MOBASH_BIN_NEW;
        if [[ -n $MOBASH_CONFIG_FILE ]]; then
            cat "$MOBASH_CONFIG_FILE" >> $MOBASH_BIN_NEW;
        fi;
        echo -e "\n################################################################################" >> $MOBASH_BIN_NEW;
        echo "# GENERATED CODE" >> $MOBASH_BIN_NEW;
        echo "################################################################################" >> $MOBASH_BIN_NEW
    };
    function mobash_usage () 
    { 
        cat  <<EOT

usage: mobash [options] <binary>                    Compile <binary> from sources.
   or: mobash [options] <binary> -r [args ..]       Compile <binary> and run it with [args ..]

Arguments:
   -sh                       Append .sh to the compiled binary
   -p, --preserve            Leave .custom and .new files in place after exit

EOT

    }
    local RS='\033[0;0m';
    local RED='\033[1;31m';
    local GRN='\033[1;32m';
    local LGRN='\033[0;32m';
    local YEL='\033[1;33m';
    local LYEL='\033[0;33m';
    local CYN='\033[0;36m';
    local LCYN='\033[0;36m';
    local BLU='\033[1;34m';
    local LBLU='\033[0;34m';
    local MGT='\033[0;35m';
    echo -e "\n${LBLU}Initializing Mobash v$MOBASH_VERSION$RS";
    local BIN_EXTENSION;
    local PRESERVE_TEMP_FILES;
    local FORMAT_WIDTH='70';
    while [[ $1 != "" ]]; do
        case $1 in 
            "-r" | '--run')
                RUN="true";
                shift 1
            ;;
            '-sh')
                BIN_EXTENSION='.sh';
                shift 1
            ;;
            '-p' | '--preserve')
                PRESERVE_TEMP_FILES='true';
                shift 1
            ;;
            *)
                source_name="${1%\.sh}";
                shift 1
            ;;
        esac;
    done;
    if [[ -n $source_name ]]; then
        echo -e "${LBLU}Building binary: $source_name$BIN_EXTENSION$RS\n";
    else
        mobash_usage;
        exit 1;
    fi;
    mobash_config_init "$0";
    mobash_get_filenames $source_name;
    mobash_init_bin;
    mobash_resolve_imports $source_name;
    mobash_get_custom_contents;
    mobash_transfer_import_contents;
    mobash_finalize
}
print_ln () 
{ 
    [[ -n $3 ]] && echo -n -e "$3";
    printf "$1" "$(echo -n -e "$2")";
    [[ -n $3 ]] && echo -n -e '\033[0;0m'
}
resolve_dir () 
{ 
    local p="${1/#~/$HOME}";
    if [[ -f $p ]]; then
        resolve_dir $(dirname "$p");
    else
        if [[ -d $p ]]; then
            ( builtin cd "$p" >&/dev/null && pwd "$2" );
        fi;
    fi
}
resolve_expanded_path () 
{ 
    local current_dir="$(resolve_dir ${1:-.})";
    local expanded_dirs=("$current_dir");
    local d;
    while [[ $current_dir != '/' ]]; do
        current_dir="$(dirname $current_dir)";
        expanded_dirs=("$current_dir" "${expanded_dirs[@]}");
    done;
    for d in "${expanded_dirs[@]}";
    do
        echo "$d";
    done
}
resolve_file_in_path () 
{ 
    local d;
    local f;
    IFS="$3";
    for d in $2;
    do
        if [[ -n $d ]]; then
            d=$(resolve_dir $d);
            f=$(find $d -type f -name "$1" 2>/dev/null | head -1);
            if [[ -n $f ]]; then
                break;
            fi;
        fi;
    done;
    echo -n "$f"
}
mo_main "$@"
